---
title: "R and Bioconductor Assignment"
author: "Stephen Kanyerezi"
date: "6/2/2021"
output:
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
---

# Question 1
Import the data described above into R, provide descriptive summaries of the subject data (using appropriate graphics and statistical summary measures) given in the diabimmune_16s_t1d_metadata.csv file. In addition, use appropriate test(s) to check for association/independency between disease status and other variables (delivery mode, gender and age). Note that age is given in days.

```{r setup, echo=TRUE, cache=TRUE, results='asis'}
library(tidyverse)
library(phyloseq)
```
```{r question 1, echo=TRUE, cache=TRUE}
sample_metadata <- read.csv("diabimmune_16s_t1d_metadata.csv", sep = ",", header = T) # read the sample data
# Explore the data and have a glimpse of it
head(sample_metadata)
tail(sample_metadata)
dim(sample_metadata)
```

## How many were cases and controls
```{r sub-section 1, echo=TRUE, cache=TRUE}
case_control_count <- sample_metadata %>% 
  group_by(Case_Control) %>% 
  summarise(Total = n(), Percentage = (Total / 777) * 100)

ggplot(case_control_count, aes(x = Case_Control, y = Total, fill = Case_Control)) + 
  geom_bar(stat = "identity") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))

```

## How many were males and females
```{r sub-section 2, echo=TRUE, cache=TRUE}
gender_counts <- sample_metadata %>% 
  group_by(Gender) %>% 
  summarise(Total = n(), Percentage = (Total / 777) * 100)

ggplot(gender_counts, aes(x = Gender, y = Total, fill = Gender)) + 
  geom_bar(stat = "identity") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))

```

### How many fall into each delivery route

```{r sub-section 3, echo=TRUE, cache=TRUE}
delivery_route_count <- sample_metadata %>% 
  group_by(Delivery_Route) %>% 
  summarise(Total = n(), Percentage = (Total / nrow(sample_metadata)) * 100)

ggplot(delivery_route_count, aes(x = Delivery_Route, y = Total, fill = Delivery_Route)) + 
  geom_bar(stat = "identity") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"))
```
## Cases and controls versus gender

```{r sub-section 4, echo=TRUE, cache=TRUE}
status_gender <- sample_metadata %>% 
  group_by(Gender, Case_Control) %>% 
  summarise(Total = n(), Percentage = (Total / nrow(sample_metadata)) * 100)

ggplot(status_gender, aes(fill=Gender, y=Total, x=Case_Control)) + 
  geom_bar(position="dodge", stat="identity") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
                                                      panel.background = element_blank(), axis.line = element_line(colour = "black"))
```

## Cases and controls, gender and delivery route

```{r sub-section 5, echo=TRUE, cache=TRUE}
status_gender_delivery <- sample_metadata %>% 
  group_by(Gender, Case_Control, Delivery_Route) %>% 
  summarise(Total = n(), Percentage = (Total / nrow(sample_metadata)) * 100)

ggplot(status_gender_delivery, aes(x = Gender, y = Total, fill = Delivery_Route)) + geom_bar(position="dodge", stat="identity") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), panel.background = element_blank(), axis.line = element_line(colour = "black"), axis.text.x = element_text(angle = 45, hjust = 1)) +
   facet_grid(. ~ Case_Control) + geom_text(aes(label = Total), vjust = -0.1, position = position_dodge(width = 0.9)) +
   labs(x = "Gender")

```

# Question 2
Using phyloseq, create a phyloseq object. This will comprise the OTU abundance, taxonomy (provided in the .txt file) and sample data (provided in the .csv file)

```{r sub-section 6, echo=TRUE, cache=TRUE}

otut <- read.table("otu_table") # import otu table
#head(otut, n = 1)

taxat <- read.table("new_taxa_table") # import taxa table
#head(taxat)
dim(taxat)
dim(otut)
class(taxat)
class(otut)
otut_mat <- as.matrix(otut) # convert the otu table into a matrix
class(otut_mat)
taxat_mat <- as.matrix(taxat) # convert the taxa table into a matrix
class(taxat_mat)
#head(taxat_mat)
taxat_mat_sub <- gsub(";", "", taxat_mat) # remove ; from the columns of taxa table
#head(taxat_mat_sub)

# Our row names are ending with ; and this makes them different from the naming in the otu table
# so we need to remove the ;
mat_names <- row.names(taxat_mat_sub) # extract the rownames and store them in the mat_names object
new_naam <- gsub(";", "", mat_names) # remove ; from the mat_names and store them to new_naam
#new_naam
row.names(taxat_mat_sub) <- new_naam # now change the row names of taxat_mat_sub to the names in "new_naam

library(phyloseq)
OTU <- otu_table(otut_mat, taxa_are_rows = TRUE)
TAX <- tax_table(taxat_mat_sub)
#OTU
#TAX
samp_data <- column_to_rownames(sample_metadata, var="Sample_ID")
samp_data <- sample_data(samp_data)
physeq <- phyloseq(OTU, TAX, samp_data)
physeq <- merge_phyloseq(physeq, sample_metadata)

```

